<template>
  <div class="grid grid-cols-12 gap-6">
    <h1>Comming Soon</h1>
  </div>
  <myLoading v-show="loading" class="z-[9999]" />
</template>

<script setup>
import { ref, provide, onMounted, reactive } from "vue";
import Toastify from "toastify-js";

import xlsx from "xlsx";
import { createIcons, icons } from "lucide";
import Tabulator from "tabulator-tables";

import backendApi from "../../networkServices/api.js";
import myLoading from "@/components/myloading/Main.vue";

import { useAuthStore } from "../../stores/auth.js";
import { useRouter } from "vue-router";

import url from 'url';

const tableRef = ref();
const tabulator = ref();

const salesReportFilter = ref();
const importantNotesRef = ref();

const myrouter = useRouter();
const authStore = useAuthStore();

provide("bind[importantNotesRef]", (el) => {
  importantNotesRef.value = el;
});

const prevImportantNotes = () => {
  const el = importantNotesRef.value;
  el.tns.goTo("prev");
};

const nextImportantNotes = () => {
  const el = importantNotesRef.value;
  el.tns.goTo("next");
};

const dashboard_data = reactive({
  all_reffered: 0,
  total_earnings: 0,
  refferal_code: "",
});

const loading = ref(false);

const user_name = ref('')

const filter = reactive({
    field: "name",
    type: "like",
    value: "",
  });
  
  var  tabledata = []
  const reInitOnResizeWindow = () => {
    window.addEventListener("resize", () => {
      tabulator.value.redraw();
      createIcons({
        icons,
        "stroke-width": 1.5,
        nameAttr: "data-lucide",
      });
    });
  };
  const onFilter = () => {
    tabulator.value.setFilter(filter.field, filter.type, filter.value);
  };
  const onResetFilter = () => {
    filter.field = "name";
    filter.type = "like";
    filter.value = "";
    onFilter();
  };
  const onExportCsv = () => {
    tabulator.value.download("csv", "data.csv");
  };
  const onExportJson = () => {
    tabulator.value.download("json", "data.json");
  };
  const onExportXlsx = () => {
    const win = window;
    win.XLSX = xlsx;
    tabulator.value.download("xlsx", "data.xlsx", {
      sheetName: "Users",
    });
  };
  const onExportHtml = () => {
    tabulator.value.download("html", "data.html", {
      style: true,
    });
  };
  const onPrint = () => {
    tabulator.value.print();
  };
  
  const initializeTable = async () => {
    loading.value=true
  
    await backendApi.get("v1/users", {
      },{
      headers: {
          'Authorization': "Bearer " + authStore.access_token,
          'Content-Type': 'multipart/form-data'
      }})
      .then((response) => {
        tabledata = response.data
        loading.value=false
  
        Toastify({
          node: dom("#success-notification-content_fetch").clone().removeClass("hidden")[0],
          duration: 3000,
          newWindow: true,
          close: true,
          gravity: "top",
          position: "right",
          stopOnFocus: true,
        }).showToast();
  
      }).catch((error)=>{
        loading.value = false
        Toastify({
          node: dom("#failed-notification-content_fetch").clone().removeClass("hidden")[0],
          duration: 3000,
          newWindow: true,
          close: true,
          gravity: "top",
          position: "right",
          stopOnFocus: true,
        }).showToast();
      })
      tabulator.value = new Tabulator(tableRef.value, {
        data: tabledata,
        printAsHtml: true,
        printStyled:true,
        pagination: "local",
        paginationSize: 10,
        paginationSizeSelector: [10, 20, 30, 40],
        layout: "fitColumns",
        responsiveLayout: "collapse",
        placeholder: "No matching records found",
        printHeader: () => {
          const date = new Date()
          let day = date.getDate();
          let month = date.getMonth() + 1;
          let year = date.getFullYear();
          return `<div class="w-full flex  justify-between items-center py-3 border-b-2">
                    <h1 class="text-2xl font-bold ">All Users</h1>
                    <p class="p-2 border-2px rounded ">${day}-${month}-${year}
                  </div>`;
        },
        printFooter: () => {
          return `<div class="w-full py-3 border-dashed border-2 flex justify-center items-center w-full">
          <h2 class="w-full text-center">Generated by Maleda Mirchaye<h2>
          </div>`
        },
        columns: [
          {
            formatter: "responsiveCollapse",
            width: 40,
            minWidth: 30,
            hozAlign: "center",
            resizable: true,
            headerSort: true,
            print:false,
          },{   
            title: "Userame",
            minWidth: 200,
            field: "name",
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,      
          },{   
            title: "Email",
            minWidth: 200,
            field: "email",
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,      
          },{   
            title: "Refferal Code",
            minWidth: 200,
            field: "r_code",
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,      
          },{     
            title: "Reffered By",
            minWidth: 200,
            field: "reff",
            responsive: 1,
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,
          },{     
            title: "Email Verified",
            minWidth: 200,
            field: "email_verified_at",
            responsive: 1,
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,
          },{     
            title: "Has Profile",
            minWidth: 200,
            field: "profile",
            responsive: 1,
            hozAlign: "center",
            vertAlign: "middle",
            print: true,
            download: true,
            formatter(cell) {              
              const a = dom(`
                  <div>
                    <a href="" class="font-medium whitespace-nowrap">
                      No, Doesn't Have Profile
                    </a>
                  </div>`);
              
              const b = dom(`
                  <div>
                    <a href="" class="font-medium whitespace-nowrap">
                      Yes, Have Profile
                    </a>
                  </div>`);
            
              const c= dom(`<div class="flex flex-row justify-between items-center"></div>`)[0]
            
              if (cell.getData().profile == null) {
                c.append(a[0])
              } else {
                c.append(b[0])
              }

              return c
            },
          },{
            title: "Is Active",
            minWidth: 200,
            field: "active",
            responsive: 1,
            hozAlign: "center",
            vertAlign: "middle",
            print: false,
            download: false,
          }
        ],
        renderComplete() {
          createIcons({
            icons,
            "stroke-width": 1.5,
            nameAttr: "data-lucide",
          });
        },
      });
      reInitOnResizeWindow();
  }

onMounted(async () => {
  // loading.value = true;

  // const userData = useAuthStore();
  // if (userData.getPermission.includes(permission)) {
  //     return true;
  // }
  // console.log(authStore.user_data.profile.profile_pic)

  // if (authStore.user_data.profile || authStore.user_data.profile !== null) {
  //   user_name.value = authStore.user_data.profile.first_name + " " + authStore.user_data.profile.last_name
  // }

  // await backendApi
  //   .get("/v1/dashboard")
  //   .then((response) => {
  //     loading.value = false;
  //     dashboard_data.total_earnings = response.data[0].total_earnings ?? 0;
  //     dashboard_data.refferal_code = response.data[0].r_code ?? "Register First";
  //     dashboard_data.total_available_balance = response.data[0].available_balance ?? 0;
  //     dashboard_data.total_earning_refferal = response.data[0].total_refferal_earning ?? 0;
  //     dashboard_data.total_withdrawal = response.data[0].top_withdrawal ?? 0;
  //     dashboard_data.all_reffered = response.data[0].refferals ?? 0;
  //     dashboard_data.total_reffered_init_income = response.data[0].total_refferal_init ?? 0;
  //     dashboard_data.total_reffered_5_income = response.data[0].total_refferal_5 ?? 0;
  //     dashboard_data.total_users = response.data[0].total_users ?? 0;

  //     dashboard_data.notification = response.data[0].notifications ?? 0;

      
  //     dashboard_data.top_refferers_1_name = response.data[0].top_refferals[0].name;
  //     dashboard_data.top_refferers_1_level = response.data[0].top_refferals[0].level;
  //     dashboard_data.top_refferers_1_pic = response.data[0].top_refferals[0].pic;
  //     dashboard_data.top_refferers_1_total = response.data[0].top_refferals[0].total_reffered;
      
  //     dashboard_data.top_refferers_2_name = response.data[0].top_refferals[1].name;
  //     dashboard_data.top_refferers_2_level = response.data[0].top_refferals[1].level;
  //     dashboard_data.top_refferers_2_pic = response.data[0].top_refferals[1].pic;
  //     dashboard_data.top_refferers_2_total = response.data[0].top_refferals[1].total_reffered;
      
  //     dashboard_data.top_refferers_3_name = response.data[0].top_refferals[2].name;
  //     dashboard_data.top_refferers_3_level = response.data[0].top_refferals[2].level;
  //     dashboard_data.top_refferers_3_pic = response.data[0].top_refferals[2].pic;
  //     dashboard_data.top_refferers_3_total = response.data[0].top_refferals[2].total_reffered;

  //     dashboard_data.all_time_top_refferers_1_name = response.data[0].all_time_top_refferals[0].name;
  //     dashboard_data.all_time_top_refferers_1_level = response.data[0].all_time_top_refferals[0].level;
  //     dashboard_data.all_time_top_refferers_1_pic = response.data[0].all_time_top_refferals[0].pic;
  //     dashboard_data.all_time_top_refferers_1_total = response.data[0].all_time_top_refferals[0].total_reffered;
      
  //     dashboard_data.all_time_top_refferers_2_name = response.data[0].all_time_top_refferals[1].name;
  //     dashboard_data.all_time_top_refferers_2_level = response.data[0].all_time_top_refferals[1].level;
  //     dashboard_data.all_time_top_refferers_2_pic = response.data[0].all_time_top_refferals[1].pic;
  //     dashboard_data.all_time_top_refferers_2_total = response.data[0].all_time_top_refferals[1].total_reffered;
      
  //     dashboard_data.all_time_top_refferers_3_name = response.data[0].all_time_top_refferals[2].name;
  //     dashboard_data.all_time_top_refferers_3_level = response.data[0].all_time_top_refferals[2].level;
  //     dashboard_data.all_time_top_refferers_3_pic = response.data[0].all_time_top_refferals[2].pic;
  //     dashboard_data.all_time_top_refferers_3_total = response.data[0].all_time_top_refferals[2].total_reffered;
      
  //     dashboard_data.level = response.data[0].level;
  //     dashboard_data.position = response.data[0].position;
  //     console.log(dashboard_data);
  //   })
  //   .catch((error) => {
  //     loading.value = false;
  //   });

    // initializeTable(); 
});

// const checkPermission = (permission) => {
//   const userData = useAuthStore();
//   if (userData.getPermission.includes(permission)) {
//       return true;
//   }
// };

// function getRelativeTime(time) {
//   const createdAt = new Date(time);
//   const timeDiff = new Date().getTime() - createdAt.getTime();

//   const seconds = Math.floor(timeDiff / 1000);
//   const minutes = Math.floor(seconds / 60);
//   const hours = Math.floor(minutes / 60);
//   const days = Math.floor(hours / 24);

//   if (seconds < 60) {
//     return `${seconds} seconds ago`;
//   } else if (minutes < 60) {
//     return `${minutes} minutes ago`;
//   } else if (hours < 24) {
//     return `${hours} hours ago`;
//   } else {
//     return `${days} days ago`;
//   }
// }
</script>
